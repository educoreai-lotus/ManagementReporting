name: Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  ci_check:
    name: Verify CI passed
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify CI status
        uses: actions/github-script@v7
        with:
          script: |
            // Get branch name from context
            const branch = context.ref.replace('refs/heads/', '');
            console.log(`Checking CI status for branch: ${branch}`);
            
            // Wait for CI to complete (with timeout)
            const maxAttempts = 30; // 5 minutes max (10 seconds * 30)
            const waitInterval = 10000; // 10 seconds
            
            for (let attempt = 0; attempt < maxAttempts; attempt++) {
              const { data: runs } = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'ci.yml',
                branch: branch,
                per_page: 10 // Get more runs to find completed one
              });

              if (runs.workflow_runs.length === 0) {
                if (attempt === 0) {
                  core.setFailed('No CI runs found. Please ensure CI workflow exists and has run.');
                  return;
                }
                // If we've been waiting and suddenly no runs, continue waiting
                console.log(`Waiting for CI run to appear... (attempt ${attempt + 1}/${maxAttempts})`);
                await new Promise(resolve => setTimeout(resolve, waitInterval));
                continue;
              }

              // Find the latest completed run
              const completedRun = runs.workflow_runs.find(run => run.status === 'completed');
              
              if (completedRun) {
                if (completedRun.conclusion === 'success') {
                  console.log(`‚úÖ CI check passed (run #${completedRun.id})`);
                  return;
                } else {
                  core.setFailed(`CI has not passed. Latest completed run: ${completedRun.conclusion} (run #${completedRun.id})`);
                  return;
                }
              }

              // If no completed run yet, check the latest run status
              const latestRun = runs.workflow_runs[0];
              console.log(`CI run #${latestRun.id} is still ${latestRun.status}... (attempt ${attempt + 1}/${maxAttempts})`);
              
              // If it's the last attempt and still in progress, check if we can find any successful run
              if (attempt === maxAttempts - 1) {
                // Look for any successful completed run (not necessarily the latest)
                const successfulRun = runs.workflow_runs.find(run => 
                  run.status === 'completed' && run.conclusion === 'success'
                );
                
                if (successfulRun) {
                  console.log(`‚úÖ Found successful CI run #${successfulRun.id}`);
                  return;
                }
                
                core.setFailed(`CI run timed out. Latest run is still ${latestRun.status}. Please wait for CI to complete.`);
                return;
              }

              // Wait before next attempt
              await new Promise(resolve => setTimeout(resolve, waitInterval));
            }

  deploy_frontend:
    name: Deploy Frontend to Vercel
    needs: ci_check
    runs-on: ubuntu-latest
    environment:
      name: production-frontend
    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Verify Vercel CLI
        run: npx vercel --version

      - name: Check Vercel secrets
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          if [ -z "$VERCEL_TOKEN" ]; then
            echo "‚ùå VERCEL_TOKEN is not set in GitHub secrets"
            exit 1
          fi
          if [ -z "$VERCEL_ORG_ID" ]; then
            echo "‚ùå VERCEL_ORG_ID is not set in GitHub secrets"
            exit 1
          fi
          if [ -z "$VERCEL_PROJECT_ID" ]; then
            echo "‚ùå VERCEL_PROJECT_ID is not set in GitHub secrets"
            exit 1
          fi
          echo "‚úÖ All Vercel secrets are set"

      - name: Pull Vercel environment
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          mkdir -p .vercel
          echo "{\"projectId\":\"$VERCEL_PROJECT_ID\",\"orgId\":\"$VERCEL_ORG_ID\"}" > .vercel/project.json
          npx vercel pull --yes --environment=production --token="$VERCEL_TOKEN" || {
            echo "‚ùå Failed to pull Vercel environment"
            exit 1
          }

      - name: Build for production
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
        run: |
          npx vercel build --prod --token="$VERCEL_TOKEN" || {
            echo "‚ùå Failed to build for production"
            exit 1
          }

      - name: Deploy to Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          npx vercel deploy --prebuilt --prod --token="$VERCEL_TOKEN" || {
            echo "‚ùå Failed to deploy to Vercel"
            exit 1
          }

      - name: Deployment summary
        run: |
          echo "‚úÖ Frontend deployed to Vercel"
          echo "üîó Check deployment at: https://${{ secrets.VERCEL_PROJECT_ID }}.vercel.app"

  deploy_backend:
    name: Deploy Backend to Railway
    needs: ci_check
    runs-on: ubuntu-latest
    environment:
      name: production-backend
    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Copy DB folder to backend
        run: |
          cp -r DB backend/DB || echo "DB folder not found, migration will be skipped"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install Railway CLI
        run: npm i -g @railway/cli

      - name: Verify Railway CLI
        run: railway --version

      - name: Check Railway secrets
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          if [ -z "$RAILWAY_TOKEN" ]; then
            echo "‚ùå RAILWAY_TOKEN is not set in GitHub secrets"
            exit 1
          fi
          echo "‚úÖ Railway token is set"

      - name: Login to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          railway login --token "$RAILWAY_TOKEN" || {
            echo "‚ùå Failed to login to Railway"
            exit 1
          }

      - name: Deploy to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          railway up || {
            echo "‚ùå Failed to deploy to Railway"
            exit 1
          }

      - name: Verify deployment
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        continue-on-error: true
        run: |
          echo "‚úÖ Backend deployed to Railway"
          echo "üîó Check health endpoint at your Railway URL/health"

